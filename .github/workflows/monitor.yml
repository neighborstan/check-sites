name: Server Monitor

on:
  schedule:
    - cron: "*/5 * * * *"  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
  workflow_dispatch:       # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤
concurrency:
  group: monitor
  cancel-in-progress: false  # –Ω–µ –æ—Ç–º–µ–Ω—è—Ç—å —Ç–µ–∫—É—â–∏–µ –∑–∞–ø—É—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –Ω–æ–≤–æ–≥–æ

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # –†–∞–∑—Ä–µ—à–∞–µ–º Actions –¥–µ–ª–∞—Ç—å git push
      actions: write  # –ü—Ä–∞–≤–∞ –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ actions

    steps:
      - name: üõ†Ô∏è –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v3
        with:
          persist-credentials: true  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è git push

      - name: üîë –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç
        run: chmod +x monitoring/check_sites.sh

      - name: üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: monitoring/check_sites.sh

      - name: üìÇ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase --autostash origin main
          git add monitoring/site_status.log monitoring/site_monitor.log  # –î–æ–±–∞–≤–ª—è–µ–º –æ–±–∞ —Ñ–∞–π–ª–∞
          git commit -m "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–∞–π—Ç–æ–≤ –∏ –ª–æ–≥–æ–≤" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          git push origin main

      - name: üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 7        # —Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø—É—Å–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
          keep_minimum_runs: 10 # –≤—Å–µ–≥–¥–∞ —Ö—Ä–∞–Ω–∏—Ç—å –º–∏–Ω–∏–º—É–º 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø—É—Å–∫–æ–≤

